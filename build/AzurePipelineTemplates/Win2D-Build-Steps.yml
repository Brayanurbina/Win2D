parameters:
  PipelineType: "not set"
  # sdkVersion: 18362
  codeSignInlineOperation: |
        [
          {
              "KeyCode" : "CP-230012",
              "OperationCode" : "SigntoolSign",
              "Parameters" : {
                  "OpusName" : "Microsoft",
                  "OpusInfo" : "http://www.microsoft.com",
                  "FileDigest" : "/fd \"SHA256\"",
                  "PageHash" : "/NPH",
                  "TimeStamp" : "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
              },
              "ToolName" : "sign",
              "ToolVersion" : "1.0"
          },
          {
              "KeyCode" : "CP-230012",
              "OperationCode" : "SigntoolVerify",
              "Parameters" : {},
              "ToolName" : "sign",
              "ToolVersion" : "1.0"
          }
        ]

steps:
# # Checkout Win2D repo
# - checkout: self
#   clean: true
#   persistCredentials: True
# # Build setup - TODO this maybe is not needed
# - task: PkgESSetupBuild@12
#   name: XESSetupBuild_1
#   displayName: Setup Build
#   enabled: False
#   inputs:
#     branchVersionExcludeBranch: master
#     disableWorkspace: true
- task: CmdLine@1
  displayName: Ensure release branch not merged to master
  inputs:
    filename: cmd
    arguments: /c if exist build\pkges\PoliCheckExclusions.txt exit 1
- task: BatchScript@1
  displayName: Run download-nuget.cmd
  inputs:
    filename: build\nuget\download-nuget.cmd
- task: NuGetAuthenticate@1
  displayName: NuGet Authenticate
  inputs:
    nuGetServiceConnections: Win2DWinUI
- task: CmdLine@2
  displayName: Move telemetry files
  inputs:
    script: "call nuget.exe restore -NonInteractive -configFile $(Build.SourcesDirectory)/release-nuget.config -PackagesDirectory $(Build.SourcesDirectory)/packages $(Build.SourcesDirectory)/build/release-pkges/packages.config || exit /b 1\n      \ndel $(Build.SourcesDirectory)\\winrt\\inc\\MicrosoftTelemetry.h || exit /b 1\n      \nmove /Y $(Build.SourcesDirectory)\\packages\\Microsoft.Win2D.Telemetry.1.0.2\\build\\include\\MicrosoftTelemetry.h $(Build.SourcesDirectory)\\winrt\\inc\\MicrosoftTelemetry.h || exit /b 1"
- task: MSBuild@1
  displayName: Build Win2D.proj
  inputs:
    solution: Win2D.proj
    msbuildVersion: 16.0
    configuration: Release
    msbuildArguments: /p:BuildTests=false /p:BuildDocs=false /p:BuildTools=false /p:RunTests=false /p:BuildConfigurations=Release /p:AzurePipeline=true
    maximumCpuCount: true
- task: BatchScript@1
  displayName: build-nupkg
  inputs:
    filename: build/nuget/build-nupkg.cmd
    arguments: integration
- task: BatchScript@1
  displayName: Run clear-space.cmd
  inputs:
    filename: build\clear-space.cmd
    workingFolder: $(Build.SourcesDirectory)
- task: CopyFiles@2
  displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: bin
    Contents: >-
      *.nupkg

      signed\**

      docs.zip

      **\*.pdb

      **\*.dll
    TargetFolder: $(Build.ArtifactStagingDirectory)
- task: PublishSymbols@2
  displayName: Publish symbols path
  inputs:
    SearchPattern: '**/bin/**/release/winrt.dll.uap/Microsoft.Graphics.Canvas.pdb'
    SymbolServerType: TeamServices
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'