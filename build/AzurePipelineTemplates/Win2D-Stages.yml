parameters:
- name: "RunTests"
  type: boolean
  default: True
- name: "PushPackageToInternalFeed"
  type: boolean
  default: False  
- name: "PipelineType"
  type: string
  default: "not_set"
- name: "VMImage"
  type: string
  default: "windows-2022"

# Builds Win2D code and nuget package
stages:
- stage: Build_Win2D
  jobs:
  # Build Win2D 
  - job: Version
    pool:
      vmImage: '${{ parameters.VMImage }}'
    steps:
    # Set the build number and version
    - template: Win2D-VersionNumber.yml
      parameters:
        PipelineType: ${{ parameters.PipelineType }}
    # Build Win2D
  # - job: BuildWin2D
  #   dependson: Version
  #   - template: Win2D-Build-Steps.yml
  #     parameters:
  #       PipelineType: ${{ parameters.PipelineType }}
  - job: Build_Win2D
    dependsOn: Version
    strategy:
      matrix:
        x86:
          # x86 is responsible for building docs and tools, which is AnyCPU
          architecture: "Win32;AnyCPU"
          buildConfiguration: "Release"
        x64:
          architecture: "x64"
          buildConfiguration: "Release"
        ARM:
          architecture: "ARM"
          buildConfiguration: "Release"
        ARM64:
          architecture: "ARM64"
          buildConfiguration: "Release"
    pool:
      vmImage: '${{ parameters.VMImage }}'
    variables:
      version: $[ dependencies.Version.outputs['version'] ]
    steps:
    - template: Win2D-ParallelBuild-Steps.yml
      parameters:
        BuildTests: False
        RunTests: False
        BuildDocs: True
        BuildTools: True
- stage: Build_Nupkg
  dependsOn: Build_Win2D
  jobs:
  - job: Run_BuildNupkg
    pool:
      vmImage: '${{ parameters.VMImage }}'
    steps:
    - template: Win2D-BuildNupkg.yml
- stage: Test_Win2D
  # Empty
  dependsOn:
  jobs:
  - job: Test_Win2D
    strategy:
      matrix:
        x86:
          architecture: "Win32"
          binDirectory: "uapx86"
          buildConfiguration: "Release"
        x64:
          architecture: "x64"
          binDirectory: "uapx64"
          buildConfiguration: "Release"
        # TODO - Test projects don't support ARM and ARM64
        # ARM:
        #   architecture: "ARM"
        #   buildConfiguration: "Release"
        # ARM64:
        #   architecture: "ARM64"
        #   buildConfiguration: "Release"
    pool:
      vmImage: '${{ parameters.VMImage }}'
    variables:
      version: $[ dependencies.Version.outputs['version'] ]
    steps:
    - template: Win2D-ParallelBuild-Steps.yml
      parameters:
        BuildTests: True
        RunTests: True
        BuildDocs: False
        BuildToos: False
        PublishBinaries: False

